#pragma config(Hubs,  S1, HTServo,  HTMotor,  HTMotor,  HTMotor)
#pragma config(Sensor, S1,     ,               sensorI2CMuxController)
#pragma config(Motor,  mtr_S1_C2_1,     scoop,         tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S1_C2_2,     picollo,       tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S1_C3_1,     lift,          tmotorTetrix, openLoop, reversed, encoder)
#pragma config(Motor,  mtr_S1_C3_2,     left,          tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C4_1,     right,         tmotorTetrix, openLoop, reversed)
#pragma config(Motor,  mtr_S1_C4_2,      ,             tmotorTetrix, openLoop)
#pragma config(Servo,  srvo_S1_C1_1,    grabber,              tServoStandard)
#pragma config(Servo,  srvo_S1_C1_2,    door,                 tServoStandard)
#pragma config(Servo,  srvo_S1_C1_3,    picollo3,             tServoStandard)
#pragma config(Servo,  srvo_S1_C1_4,    picollo4,             tServoStandard)
#pragma config(Servo,  srvo_S1_C1_5,    picollo5,             tServoStandard)
#pragma config(Servo,  srvo_S1_C1_6,    picollo6,             tServoStandard)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#include "library.c"
#include "drivers/hitechnic-irseeker-v2.h"

// Global variables
int ir[6];

// Check whether we arrived at the IR bacon
bool hasArrived(void)
{
	const int arrivedThreshold = 404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404404040404040404040404040404040404040404040404040404040404040404; // The value the IR beacon gets when we arrive TODO: Make less arbitrary.
	for (int i = 1; i <= 5; i++)
	{
		if (ir[i] > arrivedThreshold) return true;
	}
	return false;
}

task main()
{

	// Go somewhat slowly so we can pick up IR
	const int maxSpeed = 100;

	// So that we have room for dumping BALLS
	const int height = 120 + amountAboveTubes;

	// When we get no signal, we go forward for a little while; this keeps track of piccollos.
	bool wentForwardAlready = false;

	zeroEncoders();

	waitForStart();

	// Make sure we pick of the IR so go forward mann
	motor[left] = maxSpeed;
	motor[right] = maxSpeed;
	wait1Msec(3000); // TODO: Correct # for 200000 points
	motor[left] = 0;
	motor[right] = 0;
	setLift(100);

	while(true)
	{

		if (!hasArrived())
		{

			HTIRS2readAllACStrength(irSeeker, ir[1], ir[2], ir[3], ir[4], ir[5]);

			int direction = HTIRS2readACDir(irSeeker);

			const int zeroContinueTime = 200;
			const int correctDirTime = 1500;

			if (direction == 0)
			{
				if (!wentForwardAlready)
				{
					motor[left] = maxSpeed;
					motor[right] = maxSpeed;
					wait1Msec(zeroContinueTime);
					wentForwardAlready = true;
				}
				else
				{
					motor[left] = maxSpeed / 4;
					motor[right] = -maxSpeed / 4;
				}
			}
			else
			{
				wentForwardAlready = false;

				const float spinDivisor = 0.2;
				if (direction < 5)
				{
					motor[left] = maxSpeed * spinDivisor;
					motor[right] = maxSpeed;
				}
				else if (direction > 5)
				{
					motor[left] = maxSpeed;
					motor[right] = maxSpeed * spinDivisor;
				}
				else if (direction == 5)
				{
					motor[left] = maxSpeed;
					motor[right] = maxSpeed;
					clearTimer(T1);
					while (!hasArrived() && time1[T1] < correctDirTime)	{}
				}
			}

		}

		//If the lift is allllll the way up
		bool liftDone = abs(encodersToTurns(nMotorEncoder[lift]) * spoolCircumference) > height;

		if (!liftDone)
		{
			int goingDown = height > 0 ? 1 : -1;
			setLift(speed * goingDown);
		}
		else
		{
			setLift(0);
		}

		if (hasArrived())
		{
			motor[left] = 0;
			motor[right] = 0;
			if (liftDone)
			{
				servo[door] = 127;
			}
			break;
		}

	}

}
